<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversations - Place de Marché</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {font-family: 'Roboto', sans-serif; background: #f0f2f5; margin: 0; padding: 0;}
        header {display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;}
        h1 {margin: 0; font-size: 24px; color: #333;}
        #authStatus {font-size: 15px; color: #555;}
        #feed {max-width: 800px; margin: 0 auto; padding: 20px 10px;}
        .post {background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden;}
        .post:hover {transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0,0,0,0.12);}
        .header {display: flex; align-items: center; padding: 15px;}
        .avatar {width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 28px; margin-right: 12px; flex-shrink: 0;}
        .user-info {flex-grow: 1;}
        .username {font-weight: 600; font-size: 16px; color: #1877f2; text-decoration: none;}
        .title {font-size: 14px; color: #333; margin: 4px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .time {font-size: 13px; color: #606770;}
        .loading {text-align: center; padding: 40px; color: #606770; font-size: 18px;}
    </style>
</head>
<body>
    <header>
        <a href="/" style="font-size: 28px; margin-right: 20px; text-decoration:none; color:black;">←</a>
        <h1>Conversations</h1>
        <div id="authStatus">Chargement...</div>
    </header>
    <div id="feed"><div class="loading">Chargement...</div></div>

    <script>
        if (!localStorage.getItem('username')) {
            location.href = `/login.html?next=${encodeURIComponent(location.href)}`;
        }

        function getColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        function updateAuthStatus() {
            const status = document.getElementById('authStatus');
            const username = localStorage.getItem('username');
            if (username) {
                status.innerHTML = `Connecté : ${username} <button onclick="logout()" style="margin-left:15px; padding:5px 10px; background:#e4e6eb; border:none; border-radius:6px; cursor:pointer;">Déconnexion</button>`;
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        async function loadConversations() {
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');
            const params = new URLSearchParams();
            params.append('username', username);
            params.append('password', password);

            try {
                const res = await fetch(`/api/conversations?${params}`);
                if (!res.ok) throw new Error();
                const convs = await res.json();
                const feed = document.getElementById('feed');
                feed.innerHTML = '';
                if (convs.length === 0) {
                    feed.innerHTML = '<div class="loading">Aucune conversation pour le moment.</div>';
                    return;
                }
                convs.forEach(conv => {
                    const div = document.createElement('div');
                    div.className = 'post';
                    div.onclick = () => location.href = `/chat?seller=${encodeURIComponent(conv.user)}`;
                    const header = document.createElement('div');
                    header.className = 'header';
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = conv.user.charAt(0).toUpperCase();
                    avatar.style.backgroundColor = getColor(conv.user);
                    const info = document.createElement('div');
                    info.className = 'user-info';
                    const name = document.createElement('div');
                    name.className = 'username';
                    name.textContent = conv.user;
                    const last = document.createElement('div');
                    last.className = 'title';
                    last.textContent = (conv.last_text || '').substring(0, 50) + ((conv.last_text || '').length > 50 ? '...' : '');
                    const time = document.createElement('div');
                    time.className = 'time';
                    time.textContent = conv.last_time ? new Date(conv.last_time).toLocaleString('fr-FR', {month:'short', day:'numeric', hour:'numeric', minute:'2-digit'}) : '';
                    info.append(name, last, time);
                    header.append(avatar, info);
                    div.appendChild(header);
                    feed.appendChild(div);
                });
            } catch (e) {
                document.getElementById('feed').innerHTML = '<div class="loading">Erreur de chargement.</div>';
            }
        }

        updateAuthStatus();
        loadConversations();
        setInterval(loadConversations, 30000);
    </script>
</body>
</html>
