<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f8f9fa; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        .whatsapp-btn { background:#25D366; color:white; border:none; }
        .whatsapp-btn:hover { background:#1ebe57; }
        .product-img { height: 220px; object-fit: cover; border-radius: 12px; }
        .card { transition:0.3s; }
        .card:hover { transform:scale(1.03); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-5 fw-bold">{{SUBCATEGORY}}</h1>
        <a href="{{BACK_LINK}}" class="btn btn-secondary mb-4">Retour</a>
        <div class="row" id="products-container">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">Chargement des produits...</p>
            </div>
        </div>
    </div>

    <script>
        const CURRENT_SUBCAT = "{{SUBCATEGORY}}";
        const MAIN_CAT = "{{MAIN_CATEGORY}}";

        function loadProducts() {
            fetch('/api/products')
                .then(r => r.json())
                .then(products => {
                    const container = document.getElementById('products-container');
                    container.innerHTML = '';

                    const filtered = products.filter(p =>
                        p.category === MAIN_CAT && p.subcategory === CURRENT_SUBCAT
                    );

                    if (filtered.length === 0) {
                        container.innerHTML = `<p class="text-center py-5 text-muted fs-4">Aucun produit dans "${CURRENT_SUBCAT}" pour le moment.</p>`;
                        return;
                    }

                    filtered.forEach(p => {
                        const card = `
                        <div class="col-md-12 col-sm-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm">
                                <img src="${p.image_base64}" class="card-img-top product-img" alt="${p.title}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${p.title}</h5>
                                    <p class="text-muted flex-grow-1">${p.desc}</p>
                                    <div class="mt-auto">
                                        <p class="fw-bold fs-5 text-primary">${p.price} € + ${p.shipping_price} € livraison</p>
                                        <p class="text-success">Stock: ${p.stock}</p>
                                        <a href="https://wa.me/${p.phone}?text=Salut ${p.username} ! Je veux acheter: ${encodeURIComponent(p.title)}"
                                           class="btn whatsapp-btn w-100">Contacter sur WhatsApp</a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        container.innerHTML += card;
                    });
                })
                .catch(err => {
                    container.innerHTML = '<p class="text-danger text-center">Erreur de chargement</p>';
                });
        }

        window.addEventListener('load', loadProducts);
    </script>
</body>
</html>