<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Place de Marché</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {font-family: 'Roboto', sans-serif; background: #f0f2f5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;}
        header {background: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center;}
        .avatar {width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px; margin-right: 12px;}
        #messages {flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;}
        .bubble {max-width: 75%; padding: 11px 16px; border-radius: 20px; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);}
        .sent {background: #1877f2; color: white; align-self: flex-end; border-bottom-right-radius: 4px;}
        .received {background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px;}
        .input-bar {display: flex; padding: 10px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);}
        #messageInput {flex: 1; padding: 14px; border-radius: 25px; border: 1px solid #ddd; margin-right: 10px; font-size: 16px;}
        #sendBtn {background: #1877f2; color: white; border: none; padding: 0 24px; border-radius: 25px; font-weight: bold; cursor: pointer;}
    </style>
</head>
<body>
    <header>
        <a href="/conversations" style="font-size: 28px; margin-right: 20px; text-decoration:none; color:black;">←</a>
        <div class="avatar" id="sellerAvatar"></div>
        <div id="sellerName" style="font-weight:600; font-size:18px;"></div>
    </header>
    <div id="messages"></div>
    <div class="input-bar">
        <input type="text" id="messageInput" placeholder="Écris un message..." autocomplete="off">
        <button id="sendBtn">Envoyer</button>
    </div>

    <script>
        if (!localStorage.getItem('username')) {
            location.href = `/login.html?next=${encodeURIComponent(location.href)}`;
        }

        const urlParams = new URLSearchParams(location.search);
        const seller = urlParams.get('seller');
        if (!seller) location.href = '/';

        document.getElementById('sellerName').textContent = seller;
        const avatar = document.getElementById('sellerAvatar');
        avatar.textContent = seller.charAt(0).toUpperCase();
        let hash = 0;
        for (let i = 0; i < seller.length; i++) hash = seller.charCodeAt(i) + ((hash << 5) - hash);
        avatar.style.backgroundColor = `hsl(${Math.abs(hash % 360)}, 70%, 50%)`;

        const username = localStorage.getItem('username');
        const password = localStorage.getItem('password');
        const messagesDiv = document.getElementById('messages');

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(msg) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble ' + (msg.from === username ? 'sent' : 'received');
            bubble.textContent = msg.text;
            messagesDiv.appendChild(bubble);
            scrollToBottom();
        }

        // Chargement historique
        async function loadHistory() {
            const params = new URLSearchParams();
            params.append('with', seller);
            params.append('username', username);
            params.append('password', password);
            const res = await fetch(`/api/messages?${params}`);
            if (res.ok) {
                const msgs = await res.json();
                msgs.forEach(addMessage);
                scrollToBottom();
            }
        }
        loadHistory();

        const socket = io({ auth: { username, password } });

        socket.on('new_message', msg => {
            // On ne reçoit que les messages de cette conversation
            if ((msg.from === username && msg.to === seller) || (msg.from === seller && msg.to === username)) {
                addMessage(msg);
            }
        });

        document.getElementById('sendBtn').onclick = () => {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (text) {
                socket.emit('send_message', { to: seller, text });
                input.value = '';
            }
        };

        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('sendBtn').click();
        });
    </script>
</body>
</html>
