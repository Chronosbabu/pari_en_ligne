<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place de March√©</title>
    <style>
        body {font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0;}
        header {display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;}
        h1 {margin: 0; font-size: 24px;}
        #authStatus {font-size: 15px;}
        #feed {max-width: 800px; margin: 0 auto; padding: 20px 10px;}
        .post {background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden;}
        .header {display: flex; align-items: center; padding: 15px 15px 10px;}
        .avatar {width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 28px; margin-right: 12px; flex-shrink: 0;}
        .user-info {flex-grow: 1;}
        .username {font-weight: 600; font-size: 15px; color: #1877f2; text-decoration: none; cursor: pointer;}
        .title {font-size: 19px; font-weight: bold; color: #1c1e21; margin: 4px 0;}
        .prices {font-size: 17px; font-weight: 600; color: #1877f2;}
        .time {font-size: 13px; color: #606770; margin-top: 4px;}
        img {width: 100%; height: auto; display: block;}
        .loading {text-align: center; padding: 40px; color: #606770; font-size: 18px;}
    </style>
</head>
<body>
    <header>
        <h1>üõí Place de March√©</h1>
        <div id="messagesIcon" style="margin-left: auto; margin-right: 20px;"></div>
        <div id="authStatus">Chargement...</div>
    </header>
    <div id="feed"><div class="loading">Chargement...</div></div>

    <script>
        function getColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        function updateAuthStatus() {
            const status = document.getElementById('authStatus');
            const messagesIcon = document.getElementById('messagesIcon');
            const username = localStorage.getItem('username');
            if (username) {
                status.innerHTML = `Connect√© : ${username} <button onclick="logout()" style="margin-left:15px; padding:5px 10px; background:#e4e6eb; border:none; border-radius:6px; cursor:pointer;">D√©connexion</button>`;
                messagesIcon.innerHTML = '<a href="/conversations.html" style="font-size:24px; text-decoration:none; color:black;">üí¨</a>';
            } else {
                status.innerHTML = '<a href="/login.html" style="color:#1877f2; font-weight:600; text-decoration:none;">Se connecter</a>';
                messagesIcon.innerHTML = '';
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/posts');
                if (!res.ok) throw new Error();
                let posts = await res.json();
                const feed = document.getElementById('feed');
                feed.innerHTML = '';
                if (posts.length === 0) {
                    feed.innerHTML = '<div class="loading">Aucune publication pour le moment.</div>';
                    return;
                }
                posts.sort((a, b) => new Date(b.time) - new Date(a.time))
                    .forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';

                        const header = document.createElement('div');
                        header.className = 'header';

                        const avatar = document.createElement('div');
                        avatar.className = 'avatar';
                        avatar.textContent = post.username.charAt(0).toUpperCase();
                        avatar.style.backgroundColor = getColor(post.username);

                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info';

                        const usernameLink = document.createElement('a');
                        usernameLink.href = `/chat?seller=${encodeURIComponent(post.username)}`;  // ‚Üê CORRIG√â ICI
                        usernameLink.className = 'username';
                        usernameLink.textContent = post.username;

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'title';
                        titleDiv.textContent = post.title || 'Sans titre';

                        const pricesDiv = document.createElement('div');
                        pricesDiv.className = 'prices';
                        pricesDiv.textContent = `${post.price || 'N/A'} ‚Ç¨ ‚Ä¢ Livraison ${post.shipping_price || 'N/A'} ‚Ç¨`;

                        const timeSpan = document.createElement('div');
                        timeSpan.className = 'time';
                        timeSpan.textContent = new Date(post.time).toLocaleString('fr-FR');

                        userInfo.append(usernameLink, titleDiv, pricesDiv, timeSpan);
                        header.append(avatar, userInfo);

                        const img = document.createElement('img');
                        img.src = post.image_base64;
                        img.alt = 'Article';

                        postDiv.append(header, img);
                        feed.appendChild(postDiv);
                    });
            } catch (e) {
                document.getElementById('feed').innerHTML = '<div class="loading">Erreur de chargement.</div>';
            }
        }

        updateAuthStatus();
        loadPosts();
        setInterval(loadPosts, 30000);
    </script>
</body>
</html>
