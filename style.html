<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pari en Ligne - Place de MarchÃ©</title>
    <style>
        body {font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0;}
        h1 {text-align: center; padding: 20px; color: #1c1e21; background: white; margin: 0 0 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        #feed {max-width: 800px; margin: 0 auto; padding: 10px;}
        .post {background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden;}
        .header {display: flex; align-items: center; padding: 15px 15px 10px;}
        .avatar {width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 28px; margin-right: 12px; flex-shrink: 0;}
        .user-info {flex-grow: 1;}
        .username {font-weight: 600; font-size: 15px; color: #1c1e21;}
        .time {font-size: 13px; color: #606770;}
        .description {padding: 0 15px 12px; font-size: 15px; color: #1c1e21; word-wrap: break-word;}
        img {width: 100%; height: auto; display: block;}
        .loading {text-align: center; padding: 40px; color: #606770; font-size: 18px;}
    </style>
</head>
<body>
    <h1>ðŸ›’ Place de MarchÃ© - Pari en Ligne</h1>
    <div id="feed"><div class="loading">Chargement des publications...</div></div>

    <script>
        function getColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/posts');
                if (!res.ok) throw new Error();
                let posts = await res.json();

                const feed = document.getElementById('feed');
                feed.innerHTML = '';

                if (posts.length === 0) {
                    feed.innerHTML = '<div class="loading">Aucune publication pour le moment.</div>';
                    return;
                }

                posts
                    .sort((a, b) => new Date(b.time) - new Date(a.time))
                    .forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';

                        const header = document.createElement('div');
                        header.className = 'header';

                        const avatar = document.createElement('div');
                        avatar.className = 'avatar';
                        avatar.textContent = post.username.charAt(0).toUpperCase();
                        avatar.style.backgroundColor = getColor(post.username);

                        const userInfo = document.createElement('div');
                        userInfo.className = 'user-info';

                        const usernameSpan = document.createElement('div');
                        usernameSpan.className = 'username';
                        usernameSpan.textContent = post.username;

                        const timeSpan = document.createElement('div');
                        timeSpan.className = 'time';
                        timeSpan.textContent = new Date(post.time).toLocaleString('fr-FR');

                        userInfo.appendChild(usernameSpan);
                        userInfo.appendChild(timeSpan);
                        header.appendChild(avatar);
                        header.appendChild(userInfo);

                        const desc = document.createElement('div');
                        desc.className = 'description';
                        desc.textContent = post.description;

                        const img = document.createElement('img');
                        img.src = post.image_base64;
                        img.alt = 'Publication';

                        postDiv.appendChild(header);
                        postDiv.appendChild(img);
                        postDiv.appendChild(desc);
                        feed.appendChild(postDiv);
                    });
            } catch (e) {
                document.getElementById('feed').innerHTML = '<div class="loading">Erreur de chargement. RÃ©essayez.</div>';
            }
        }

        loadPosts();
        setInterval(loadPosts, 30000); // refresh toutes les 30 secondes
    </script>
</body>
</html>
